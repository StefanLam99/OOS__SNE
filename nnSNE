from time import time
import numpy as np
from tensorflow import keras
from utils import blockPrint, enablePrint
from tSNE import cond_probs, joint_average_P, joint_Q, pca
from autoencoder import *
from keras.models import load_model
from utils import plot
from datasets import Dataset
from  neural_tSNE import *
from neuralREG_tsne import *
layer_dim = [1024,500,500,2000, 2]
seed = 0
dataset = Dataset(seed)
#X, y , X_train, y_train, X_test, y_test = dataset.get_MNIST_data(n_train=500)
X, y , X_train, y_train, X_test, y_test = dataset.get_coil20_data()
RBM = Autoencoder(layer_dim)
RBM.pretrain(X_train.T, epochs=15)
RBM.save('Models/weightsRBM/coil20')
#RBM = RBM.pretrained_from_file('Models/coil20/test')
autoencoder, encoder, decoder = RBM.unroll()
#autoencoder.save('autoencoderRBMcoil20')
encoder.summary()
autoencoder.summary()
decoder.summary()


neural_model = neural_tSNE(epochs=50, batch_size=480, lr=0.01)

#neural_model.build_nn(1024)
neural_model.load_RBM('Models/weightsRBM/coil20')
losses = neural_model.train(X_train)
np.savetxt('Models/coil20/coil20rbmlosses.csv', losses, delimiter=',')
#neural_model.save('Models/coil20/parEncoderRBM')
#neural_model.load_model('Models/coil20/parEncoderRBM')
#neural_model.load_model(model)
Y = neural_model.predict(X_train)
plot(Y, y_train, s=1, linewidth=0.1, cmap='gist_rainbow', title='coil20 960 with rbm')




''' 
neuralREG_model = neuralREG_tSNE(epochs=50, batch_size=480, lr=0.01, labda=0, toTrain=False)

#neuralREG_model.build_nn(1024)

neuralREG_model.load_model('autoencoderRBMcoil20')
losses = neuralREG_model.train(X)

#neuralREG_model.load_model('Models/coil20/regautoEncoderRBM')
#neuralREG_model.save('Models/coil20/regautoEncoderRBM')
np.savetxt('coil20rbmREG0losses.csv', losses, delimiter=',')
Y = neuralREG_model.predict(X)
print(Y)
print(y)
print(type(Y))
neuralREG_model.model.summary()
neuralREG_model.encoder.summary()
neuralREG_model.decoder.summary()
plot(Y['encoded'], y, s=1, linewidth=0.1, cmap='gist_rainbow', title='coil20 1440 with rbm labda = 0')

YY = neuralREG_model.predict_encoder(X)
plot(YY, y, s=1, linewidth=0.1, cmap='gist_rainbow', title='test encoder')
'''